<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Carte ‚Äì Ao√ªt 1944</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100%; }

    .legend {
      background: #fff;
      padding: 8px 10px;
      line-height: 1.4;
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      border-radius: 6px;
      box-shadow: 0 0 12px rgba(0,0,0,.15);
    }

    /* Ic√¥nes Leaflet propres */
    .leaflet-div-icon { background: transparent; border: none; user-select: none; }
    .icon-swords svg, .icon-cross svg { display:block; }
    .icon-swords path,
    .icon-cross path, .icon-cross rect {
      vector-effect: non-scaling-stroke;
      shape-rendering: geometricPrecision;
    }

    /* ===== Barre de menus / ic√¥nes communes ===== */
    .communes-control {
      background:#fff;
      padding:10px;
      border-radius:8px;
      box-shadow:0 0 12px rgba(0,0,0,.15);
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      max-width: 420px;
    }
    .communes-control .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .communes-control .row + .row { margin-top:8px; }
    .communes-control select {
      flex:1 1 auto; min-width:220px;
      padding:6px 8px; border:1px solid #ddd; border-radius:6px;
      background:#fff;
    }
    .pillbar {
      display:flex; gap:6px; overflow:auto; padding-bottom:2px; max-width:400px;
    }
    .pillbar::-webkit-scrollbar { height:6px; }
    .pill {
      flex:0 0 auto;
      padding:6px 10px;
      border:1px solid #d0d7de;
      border-radius:999px;
      background:#f6f8fa;
      cursor:pointer;
      white-space:nowrap;
      transition:background .15s, transform .05s;
      user-select:none;
    }
    .pill:hover { background:#eef2f6; }
    .pill:active { transform:translateY(1px); }
    .btn {
      padding:6px 10px; border:1px solid #d0d7de; border-radius:6px; background:#fff; cursor:pointer;
    }
    .btn:hover { background:#f3f4f6; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    // --------- Carte ----------
    const map = L.map('map').setView([45.05, 5.83], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    // --------- Ic√¥nes SVG (on garde TES ic√¥nes) ----------
    const svgCross = `
      <svg width="26" height="26" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M10 2h4v6h6v4h-6v10h-4V12H4V8h6z" fill="#c1121f"/>
        <rect x="9.5" y="1.5" width="5" height="21" fill="none" stroke="#7a0a12" stroke-width="1"/>
        <rect x="1.5" y="7.5" width="21" height="5" fill="none" stroke="#7a0a12" stroke-width="1"/>
      </svg>`;
    const svgSwords = `
      <svg width="28" height="28" viewBox="0 0 24 24" aria-hidden="true">
        <g stroke="#0b2545" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none">
          <path d="M4 5l7 7" />
          <path d="M20 5l-7 7" />
          <path d="M3 7l3-3" />
          <path d="M21 7l-3-3" />
          <path d="M7 9l-2 2" />
          <path d="M17 9l2 2" />
        </g>
      </svg>`;

    const iconCross  = L.divIcon({ className: 'icon-cross',  html: svgCross,  iconSize: [26,26], iconAnchor: [13,26], popupAnchor: [0,-22] });
    const iconSwords = L.divIcon({ className: 'icon-swords', html: svgSwords, iconSize: [28,28], iconAnchor: [14,28], popupAnchor: [0,-24] });
    const iconDot    = L.divIcon({ className: 'icon-dot',    html: '<svg width="20" height="20"><circle cx="10" cy="10" r="6" fill="#222"/></svg>', iconSize: [20,20], iconAnchor: [10,20], popupAnchor: [0,-18] });

    function getIcon(categorie = "") {
      const c = (categorie || "").toLowerCase();
      if (c.includes("ex√©cution") || c.includes("victime")) return iconCross;   // ‚úùÔ∏è
      if (c.includes("combat")) return iconSwords;                               // ‚öîÔ∏è
      return iconDot;                                                            // d√©faut
    }

    // --------- Index des communes & marqueurs ----------
    const allMarkers = [];
    const communeIndex = new Map(); // "Commune" -> { markers:[], bounds:L.LatLngBounds }

    function addToCommuneIndex(commune, marker) {
      const key = (commune || "").trim();
      if (!key) return;
      let entry = communeIndex.get(key);
      if (!entry) {
        entry = { markers: [], bounds: null };
        communeIndex.set(key, entry);
      }
      entry.markers.push(marker);
      const mlatlng = marker.getLatLng();
      entry.bounds = entry.bounds ? entry.bounds.extend(mlatlng) : L.latLngBounds(mlatlng, mlatlng);
    }

    function zoomToCommune(name) {
      const key = (name || "").trim();
      if (!communeIndex.has(key)) return;
      const entry = communeIndex.get(key);
      if (entry.bounds) {
        const b = entry.bounds;
        // Si un seul point, zoome un peu plus
        if (entry.markers.length === 1) {
          map.setView(b.getCenter(), 15, { animate: true });
        } else {
          map.fitBounds(b.pad(0.25), { animate: true });
        }
      }
      // met √† jour le hash URL (partage facile)
      location.hash = "commune=" + encodeURIComponent(key);
    }

    function zoomAll() {
      if (allMarkers.length) {
        const allBounds = L.featureGroup(allMarkers).getBounds();
        map.fitBounds(allBounds.pad(0.2), { animate: true });
      }
      location.hash = "";
    }

    // --------- Chargement CSV ----------
    Papa.parse("data/victimes.csv?cb=" + Date.now(), {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: ({data}) => {
        console.log("Lignes lues :", data.length);

        data.forEach(row => {
          // En-t√™tes attendues :
          // Commune;Lieu;Date;Cat√©gorie;Victimes;Coordonn√©es;Source
          const coordsRaw = row["Coordonn√©es"];
          if (!coordsRaw) return;
          const parts = String(coordsRaw).replace(/"/g,"").split(",");
          if (parts.length !== 2) return;

          const lat = parseFloat(parts[0]);
          const lng = parseFloat(parts[1]);
          if (isNaN(lat) || isNaN(lng)) {
            console.warn("Coordonn√©es invalides:", coordsRaw, row);
            return;
          }

          const popup = `
            <b>${row["Commune"] || ""}</b><br/>
            <i>${row["Lieu"] || ""}</i><br/>
            üìÖ ${row["Date"] || ""}<br/>
            Cat√©gorie : ${row["Cat√©gorie"] || ""}<br/>
            Victimes : ${row["Victimes"] || ""}<br/>
            Source : ${row["Source"] || "‚Äî"}
          `;

          const marker = L.marker([lat, lng], { icon: getIcon(row["Cat√©gorie"]) })
            .addTo(map)
            .bindPopup(popup);

          allMarkers.push(marker);
          addToCommuneIndex(row["Commune"], marker);
        });

        buildCommunesControl();
        // Si URL contient #commune=..., zoom automatique
        const match = location.hash.match(/commune=([^&]+)/i);
        if (match) zoomToCommune(decodeURIComponent(match[1]));
      },
      error: (err) => console.error("Erreur PapaParse:", err)
    });

    // --------- L√©gende ----------
    const legend = L.control({ position: "bottomright" });
    legend.onAdd = function () {
      const div = L.DomUtil.create("div", "legend");
      div.innerHTML = `
        <b>L√©gende</b><br/>
        <span style="display:inline-block;vertical-align:middle;margin-right:6px;">${svgCross}</span>
        Victimes / Ex√©cutions<br/>
        <span style="display:inline-block;vertical-align:middle;margin-right:6px;">${svgSwords}</span>
        Combats
      `;
      return div;
    };
    legend.addTo(map);

    // --------- Contr√¥le "Communes" (menu + boutons rapides) ----------
    function buildCommunesControl() {
      // Liste tri√©e des communes
      const communes = Array.from(communeIndex.keys()).sort((a,b) =>
        a.localeCompare(b, 'fr', { sensitivity:'base' })
      );

      // Compter pour "boutons rapides" (top 8)
      const counts = communes.map(name => ({ name, n: communeIndex.get(name).markers.length }));
      counts.sort((a,b) => b.n - a.n);
      const top = counts.slice(0, 8).map(x => x.name);

      const Control = L.Control.extend({
        options: { position: 'topleft' },
        onAdd: function() {
          const container = L.DomUtil.create('div', 'communes-control');
          container.innerHTML = `
            <div class="row">
              <strong>Communes</strong>
              <button class="btn" type="button" data-action="zoom-all" title="Revenir √† l‚Äôensemble">Tout voir</button>
            </div>
            <div class="row">
              <select id="communeSelect">
                <option value="">‚Äî Aller √† une commune ‚Äî</option>
                ${communes.map(n => `<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join('')}
              </select>
            </div>
            <div class="row">
              <div class="pillbar" id="pillbar">
                ${top.map(n => `<button class="pill" type="button" data-commune="${escapeHtml(n)}">${escapeHtml(n)}</button>`).join('')}
              </div>
            </div>
          `;

          // Emp√™che la carte de capter le scroll/clic quand on interagit avec le contr√¥le
          L.DomEvent.disableClickPropagation(container);
          L.DomEvent.disableScrollPropagation(container);

          // √âv√©nements
          const select = container.querySelector('#communeSelect');
          select.addEventListener('change', e => {
            const name = e.target.value;
            if (name) zoomToCommune(name);
          });

          const pillbar = container.querySelector('#pillbar');
          pillbar.addEventListener('click', e => {
            const btn = e.target.closest('button.pill');
            if (!btn) return;
            zoomToCommune(btn.dataset.commune);
          });

          const btnAll = container.querySelector('[data-action="zoom-all"]');
          btnAll.addEventListener('click', zoomAll);

          return container;
        }
      });

      map.addControl(new Control());
    }

    function escapeHtml(s='') {
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
    }
  </script>
</body>
</html>
