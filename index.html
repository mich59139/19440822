<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Carte ‚Äì Ao√ªt 1944</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100%; }
    .legend {
      background: #fff;
      padding: 6px 8px;
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      border-radius: 4px;
      box-shadow: 0 0 10px rgba(0,0,0,.15);
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Leaflet JS (doit √™tre avant ton script) -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin="">
  </script>

  <!-- PapaParse pour lire le CSV -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    // --- Initialisation de la carte
    const map = L.map('map').setView([45.05, 5.82], 11);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // --- Ic√¥nes
function getIcon(categorie = "") {
  const c = categorie.toLowerCase();
  if (c.includes("ex√©cution") || c.includes("victime")) {
    return L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/512/535/535234.png",
      iconSize: [28, 28]
    });
  }
  if (c.includes("combat")) {
    return L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/512/1076/1076877.png",
      iconSize: [28, 28]
    });
  }
  // d√©faut
  return L.icon({
    iconUrl: "https://cdn-icons-png.flaticon.com/512/32/32339.png",
    iconSize: [20, 20]
  });
}

    // --- Lecture CSV (data/victimes.csv)
    Papa.parse("data/victimes.csv?cb=" + Date.now(), {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function (results) {
        console.log("Lignes lues :", results.data.length);

        results.data.forEach(row => {
          // Nom des colonnes attendues :
          // Commune ; Lieu ; Date ; Cat√©gorie ; Victimes ; Coordonn√©es ; Source
          if (!row["Coordonn√©es"]) return;

          // "45.050194,5.789038" -> [45.050194, 5.789038]
          const parts = String(row["Coordonn√©es"]).replace(/"/g, "").split(",");
          if (parts.length !== 2) return;

          const lat = parseFloat(parts[0]);
          const lng = parseFloat(parts[1]);
          if (isNaN(lat) || isNaN(lng)) {
            console.warn("Coordonn√©es invalides:", row["Coordonn√©es"], row);
            return;
          }

          const popup = `
            <b>${row["Commune"] || ""}</b><br/>
            <i>${row["Lieu"] || ""}</i><br/>
            üìÖ ${row["Date"] || ""}<br/>
            Cat√©gorie : ${row["Cat√©gorie"] || ""}<br/>
            Victimes : ${row["Victimes"] || ""}<br/>
            Source : ${row["Source"] || "‚Äî"}
          `;

          L.marker([lat, lng], { icon: getIcon(row["Cat√©gorie"]) })
            .addTo(map)
            .bindPopup(popup);
        });
      },
      error: function(err) {
        console.error("Erreur PapaParse:", err);
      }
    });

    // --- L√©gende
    const legend = L.control({ position: "bottomright" });
    legend.onAdd = function () {
      const div = L.DomUtil.create("div", "legend");
      div.innerHTML = `
        <b>L√©gende</b><br/>
        <img src="https://cdn-icons-png.flaticon.com/512/1822/1822890.png" width="16" style="vertical-align:middle"> Victimes / Ex√©cutions<br/>
        <img src="https://cdn-icons-png.flaticon.com/512/1076/1076877.png" width="16" style="vertical-align:middle"> Combats
      `;
      return div;
    };
    legend.addTo(map);
  </script>
</body>
</html>
